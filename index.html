<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­”ç‰©è¨ä¼æˆ°ï¼šè©›å’’ä¹‹é‹’</title>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            touch-action: manipulation;
            background-color: #0f172a;
        }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-active:active { transform: scale(0.95); }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* çµäººé¢¨æ ¼ç™¼å…‰ */
        @keyframes hunter-glow {
            0%, 100% { border-color: rgba(234, 179, 8, 0.6); box-shadow: 0 0 5px rgba(234, 179, 8, 0.2); }
            50% { border-color: rgba(234, 179, 8, 1); box-shadow: 0 0 15px rgba(234, 179, 8, 0.5); transform: scale(1.02); }
        }
        .target-glow {
            animation: hunter-glow 1.5s infinite ease-in-out;
            z-index: 20 !important;
        }

        /* è©›å’’è­¦å‘Šå‹•ç•« */
        @keyframes curse-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.5); border-color: rgba(220, 38, 38, 0.6); }
            50% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.8); border-color: rgba(220, 38, 38, 1); }
        }
        .curse-warning {
            animation: curse-pulse 1s infinite;
        }
    </style>
</head>
<body class="text-slate-100 min-h-[100dvh] flex flex-col">
    <div id="root" class="flex-1 flex flex-col">
        <div class="flex items-center justify-center h-screen text-slate-500 animate-pulse">
            æ­£åœ¨è¼‰å…¥å…¬æœƒè³‡æ–™...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- åœ–æ¨™å…ƒä»¶ ---
        const Icons = {
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Skull: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17l.5-2 .5 2h2l.5-2 .5 2"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>,
            Heart: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007-.004-.003-.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Help: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Minus: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Fire: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.3-1.3 1.3-2.5 2.4-3.2 0 1.6.5 3.3 1.5 4.5z"/></svg>
        };

        const CoinIcon = ({ value, className }) => (
            <div className={`
                rounded-full flex items-center justify-center font-black border border-black/20 coin-shadow select-none
                ${value === 2 ? 'bg-yellow-500 text-yellow-900' : 'bg-slate-300 text-slate-700'}
                ${className}
            `}>
                <span className="leading-none drop-shadow-sm">{value}</span>
            </div>
        );

        const PLAYER_COUNT = 4;
        const MONSTER_COUNT = 8; 
        const MAX_CARDS = 8;     
        const MAX_ROUNDS = 7;    
        const INITIAL_COINS1 = 5;
        const INITIAL_COINS2 = 3;
        
        // --- äº‚æ•¸åç¨±ç”Ÿæˆåº« ---
        const NAME_CHARS = ['å¡', 'æ–¯', 'ç‰¹', 'æ‹‰', 'å¤«', 'å¥§', 'å§†', 'è²', 'çˆ¾', 'å¾·', 'åŸº', 'å¸•', 'é­¯', 'è–©', 'ä¾', 'æ¯’', 'é–“', 'ç²', 'æ®¼', 'å¡”', 'ç¾…', 'ç´', 'äº', 'æŸ', 'æ™®', 'ç´¢', 'ç§‘', 'å°¼', 'å¸Œ', 'èŠ', 'å¤š', 'è¥¿', 'äº', 'å¤', 'é‚£'];
        
        const generateMonsterName = () => {
            const length = 3; 
            let name = "";
            for(let i=0; i<length; i++) {
                name += NAME_CHARS[Math.floor(Math.random() * NAME_CHARS.length)];
            }
            return name;
        };

        const getRandomBg = () => {
            const bgs = [
                "bg-gradient-to-b from-green-900 to-slate-900",
                "bg-gradient-to-b from-purple-900 to-slate-900",
                "bg-gradient-to-b from-red-900 to-slate-900",
                "bg-gradient-to-b from-indigo-900 to-slate-900",
                "bg-gradient-to-b from-cyan-900 to-slate-900",
                "bg-gradient-to-b from-stone-800 to-black"
            ];
            return bgs[Math.floor(Math.random() * bgs.length)];
        };

        // --- è§’è‰²è¨­å®š ---
        const getCardConfig = (speed) => {
            if (speed <= 2) return { 
                power: 2, 
                emoji: "ğŸ§š", 
                name: "å¦–ç²¾", 
                color: "bg-lime-900/80", 
                border: "border-lime-400", 
                text: "text-lime-200" 
            };
            if (speed <= 4) return { 
                power: 3, 
                emoji: "ğŸ¥·", 
                name: "å¿è€…", 
                color: "bg-blue-900/80", 
                border: "border-blue-400", 
                text: "text-blue-200" 
            };
            if (speed <= 6) return { 
                power: 4, 
                emoji: "ğŸ§â€â™€ï¸", 
                name: "ç²¾éˆ", 
                color: "bg-red-900/80", 
                border: "border-red-500", 
                text: "text-red-200" 
            };
            // é€Ÿåº¦ 7, 8
            return { 
                power: 5, 
                emoji: "ğŸ§™", 
                name: "å·«å¸«", 
                color: "bg-purple-900/80", 
                border: "border-purple-500", 
                text: "text-purple-200" 
            };
        };

        // --- è¦å‰‡è¦–çª— ---
        const RulesModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 modal-enter" onClick={onClose}>
                <div className="bg-slate-800 rounded-xl border border-yellow-600/50 w-full max-w-lg p-5 relative shadow-2xl" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-3 right-3 text-slate-400 hover:text-white">
                        <Icons.X />
                    </button>
                    
                    <h2 className="text-xl font-black text-yellow-500 mb-4 flex items-center gap-2 border-b border-white/10 pb-3">
                        <Icons.Book /> å…¬æœƒç‹©çµæŒ‡å—
                    </h2>

                    <div className="space-y-6 text-sm text-slate-300 overflow-y-auto max-h-[65vh] pr-2 custom-scrollbar">
                        
                        <section>
                            <h3 className="text-white font-bold text-base mb-1">âš”ï¸ éŠæˆ²ç›®æ¨™</h3>
                            <p className="leading-relaxed text-slate-400">
                                ç©å®¶æ‰®æ¼”å…¬æœƒæœƒé•·ï¼Œæ´¾é£æ‰‹ä¸‹çš„è§’è‰²è¨ä¼é­”ç‰©ã€‚
                                æ ¸å¿ƒåœ¨æ–¼<strong className="text-yellow-400">ã€Œæ¶å°¾åˆ€ã€</strong>ç²å–é«˜é¡è³é‡‘ï¼ŒåŒæ™‚é¿å…è¢«é­”ç‰©è©›å’’ã€‚
                            </p>
                        </section>

                        <section>
                            <h3 className="text-white font-bold text-base mb-2">ğŸ“œ è©³ç´°ç‹©çµæµç¨‹</h3>
                            <div className="space-y-3 pl-2 border-l-2 border-slate-700">
                                <div>
                                    <span className="text-yellow-200 font-bold block">1. é»é¸å¼·åŒ– (Enhance)</span>
                                    <p className="text-xs mt-1">
                                        é»æ“Šä¸‹æ–¹çš„ã€Œ+ã€æŒ‰éˆ•æ”¯ä»˜ç¡¬å¹£å¼·åŒ–æ”»æ“ŠåŠ›ğŸ—¡ï¸ (æ¯æ”¯ä»˜$1ï¼Œæ”»æ“ŠåŠ›ğŸ—¡ï¸å°±å¢åŠ 1)ã€‚<br/>
                                        <span className="text-slate-400">*å¼·åŒ–åƒ…å°æœ¬å›åˆæœ‰æ•ˆã€‚</span>
                                    </p>
                                </div>
                                <div>
                                    <span className="text-yellow-200 font-bold block">2. é¸æ“‡æ´¾é£è§’è‰² (Select)</span>
                                    <p className="text-xs mt-1">
                                        å¾æ‰‹ç‰Œä¸­é»é¸ä¸€å¼µè§’è‰²å¡ (æ•¸å­—ä»£è¡¨é€Ÿåº¦ SPD)ã€‚<br/>
                                        æ‰€æœ‰ç©å®¶ç¢ºèªå¾Œï¼ŒåŒæ™‚ç¿»é–‹å¡ç‰Œï¼Œä¸¦å…¬å¸ƒå¼·åŒ–æ•¸å€¼ã€‚
                                    </p>
                                </div>
                                <div>
                                    <span className="text-yellow-200 font-bold block">3. æ’åºæ”»æ“Š (Resolve)</span>
                                    <p className="text-xs mt-1">
                                        ä¾ç…§<strong>é€Ÿåº¦æ•¸å€¼ç”±å°åˆ°å¤§</strong>ä¾åºæ”»æ“Šã€‚<br/>
                                        è‹¥é€Ÿåº¦ç›¸åŒï¼Œå‰‡åŒæ™‚æ”»æ“Š (å‚·å®³ç–ŠåŠ )ã€‚<br/>
                                        è‹¥æˆåŠŸæ“Šæ®º <strong className="text-green-400">(HP â‰¤ 0)</strong>ï¼Œè©²é­”ç‰©æŒæœ‰çš„æ‰€æœ‰ç¡¬å¹£å°‡åˆ†åˆ¥å¹³å‡åˆ†é…çµ¦æ“Šæ®ºç©å®¶(å€‘)ï¼Œå‰©é¤˜ç¡¬å¹£å‰‡æœƒè½‰ç§»åˆ°ä¸‹ä¸€éš»é­”ç‰©ã€‚<br/>
                                        <span className="text-slate-400">*è‹¥é­”ç‰©æ­»äº¡ï¼Œå¾Œé¢é †ä½çš„ç©å®¶å°‡æœƒè‡ªå‹•æ”»æ“Šä¸‹ä¸€éš»é­”ç‰©ã€‚</span>
                                    </p>
                                </div>
                            </div>
                        </section>

                        <section className="bg-red-950/30 p-3 rounded border border-red-500/20">
                            <h3 className="text-red-400 font-bold text-base mb-2 flex items-center gap-1">
                                <Icons.Skull className="w-4 h-4" /> è©›å’’æ©Ÿåˆ¶ (å­˜æ´»æ‡²ç½°)
                            </h3>
                            <ul className="list-disc list-inside text-xs space-y-1 text-slate-300">
                                <li>
                                    å›åˆçµæŸæ™‚ï¼Œè‹¥æœ‰é­”ç‰©<strong className="text-white bg-red-800 px-1 rounded">è¢«æ”»æ“Šä½†å­˜æ´»</strong>ï¼ˆç„¡è«–å‰©é¤˜ HP ç‚ºä½•ï¼‰ã€‚
                                </li>
                                <li>
                                    è©²å›åˆ<strong>æœ€å¾Œæ”»æ“Šè©²é­”ç‰©</strong>çš„ç©å®¶ï¼ˆå€‘ï¼‰ç²å¾— 1 æšã€è©›å’’æ¨™è¨˜ã€‘ã€‚
                                </li>
                                <li className="text-red-300 mt-1">
                                    ç°¡å–®ä¾†èªªï¼šæœ€å¾Œå‡ºæ‰‹å°±è¦ç›¡å¯èƒ½æ“Šæ®ºé­”ç‰©ã€‚
                                </li>
                            </ul>
                        </section>

                        <section className="bg-slate-700/30 p-3 rounded">
                            <h3 className="text-blue-300 font-bold text-base mb-1">ğŸ† æœ€çµ‚çµç®—</h3>
                            <p className="text-xs mb-2 text-slate-400">ç•¶æ‰€æœ‰é­”ç‰©è¢«æ“Šæ®ºã€æˆ–æ˜¯7å›åˆå¾Œï¼ŒéŠæˆ²ç«‹å³çµæŸï¼š</p>
                            <ol className="list-decimal list-inside text-xs space-y-2">
                                <li className="text-red-300">
                                    <strong>è©›å’’æ‡²ç½°ï¼š</strong>å…¨å ´æŒæœ‰<strong>æœ€å¤šè©›å’’æ¨™è¨˜</strong>çš„ç©å®¶ï¼Œå…¶ç¸½é‡‘å¹£å°‡è¢«<strong className="text-red-400 text-sm">å¼·åˆ¶æ¸›åŠ</strong> ã€‚
                                </li>
                                <li className="text-yellow-300">
                                    <strong>å„ªå‹ï¼š</strong>çµç®—æ‡²ç½°å¾Œï¼ŒæŒæœ‰é‡‘å¹£æœ€é«˜è€…ç²å‹ã€‚
                                </li>
                            </ol>
                        </section>

                    </div>

                    <div className="mt-4 pt-3 border-t border-white/10 flex justify-end">
                        <button onClick={onClose} className="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded shadow transition-colors">
                            äº†è§£
                        </button>
                    </div>
                </div>
            </div>
        );

        // --- æ„Ÿè¬è¦–çª— (å«æ’è¡Œæ¦œ) ---
        const GameEndModal = ({ players, onRestart, onClose }) => {
            // 1. è¨ˆç®—æœ€é«˜è©›å’’æ•¸
            const maxCurses = Math.max(...players.map(p => p.curseCount));
            
            // 2. è™•ç†ç©å®¶æ•¸æ“šï¼šè¨ˆç®—ç¸½åˆ†ä¸¦æ‡‰ç”¨æ¸›åŠæ‡²ç½°
            const processedPlayers = players.map(p => {
                const rawScore = p.coins1 * 1 + p.coins2 * 2;
                // åªæœ‰ç•¶å…¨å ´æœ‰è©›å’’(max > 0) ä¸” è©²ç©å®¶è©›å’’æ•¸ç­‰æ–¼æœ€é«˜å€¼æ™‚ï¼Œæ‰åˆ¤å®šæ‡²ç½°
                const isPenalized = maxCurses > 0 && p.curseCount === maxCurses;
                // é‡‘å¹£æ¸›åŠï¼Œä¸æ¨å»å°æ•¸é»
                const finalScore = isPenalized ? rawScore / 2 : rawScore;
                
                return {
                    ...p,
                    rawScore,
                    finalScore,
                    isPenalized
                };
            });

            // 3. æ’åºï¼šæŒ‰æœ€çµ‚åˆ†æ•¸é«˜åˆ°ä½
            processedPlayers.sort((a, b) => b.finalScore - a.finalScore);

            const winner = processedPlayers[0];

            return (
                <div className="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4 modal-enter">
                    <div className="bg-slate-800 rounded-xl border-2 border-yellow-600 w-full max-w-sm p-6 relative shadow-2xl flex flex-col items-center text-center">
                        <button onClick={onClose} className="absolute top-3 right-3 text-slate-400 hover:text-red-500 transition-colors">
                            <Icons.X />
                        </button>
                        
                        <div className="text-5xl mb-4 animate-bounce">
                            {winner?.id === 0 ? 'ğŸ‘‘' : 'ğŸ'}
                        </div>
                        <h2 className="text-2xl font-black text-yellow-500 mb-1">ç‹©çµçµæŸ</h2>
                        <p className="text-xs text-slate-400 mb-4">
                            æœ€å¤šè©›å’’è€… ({maxCurses})ï¼š<span className="text-red-400 font-bold">é‡‘å¹£æ¸›åŠ</span>
                        </p>
                        
                        <div className="w-full bg-slate-900/80 rounded-lg p-3 mb-6 border border-slate-700 max-h-[50vh] overflow-y-auto">
                            <h3 className="text-sm font-bold text-slate-300 mb-2 border-b border-slate-600 pb-1">æœ€çµ‚æˆ°ç¸¾</h3>
                            <div className="space-y-2">
                                {processedPlayers.map((p, index) => {
                                    const isWinner = index === 0;
                                    return (
                                        <div key={p.id} className={`flex flex-col border-b border-slate-800 last:border-0 pb-1`}>
                                            <div className="flex justify-between items-center text-sm font-bold">
                                                <div className="flex items-center gap-2">
                                                    <span className={`w-5 h-5 flex items-center justify-center rounded-full text-xs ${isWinner ? 'bg-yellow-500 text-black' : 'bg-slate-700 text-slate-400'}`}>
                                                        {index + 1}
                                                    </span>
                                                    <span className={`${isWinner ? 'text-yellow-400' : 'text-slate-300'}`}>
                                                        {p.name}
                                                    </span>
                                                </div>
                                                <div className="flex flex-col items-end">
                                                    {p.isPenalized ? (
                                                        <div className="flex items-center gap-1">
                                                            <span className="text-xs text-slate-500 line-through decoration-red-500 decoration-2">${p.rawScore}</span>
                                                            <span className="text-xs text-slate-500">âœ</span>
                                                            <span className="font-mono text-lg text-red-400">${p.finalScore}</span>
                                                        </div>
                                                    ) : (
                                                        <span className="font-mono text-lg text-white">${p.finalScore}</span>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex justify-end gap-3 text-[10px] text-slate-500 mt-0.5">
                                                <span className={`${p.curseCount === maxCurses && maxCurses > 0 ? 'text-red-500 font-bold' : ''}`}>
                                                    è©›å’’: {p.curseCount}
                                                </span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <button 
                            onClick={onRestart} 
                            className="w-full bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-600 hover:to-blue-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95 border border-blue-400/30"
                        >
                            <Icons.Refresh /> å†ç©ä¸€æ¬¡
                        </button>
                    </div>
                </div>
            );
        };

        // --- é¡¯ç¤ºçµ„ä»¶ ---
        const CoinDisplay = ({ coins2, coins1, curseCount, compact = false }) => (
            <div className={`flex items-center gap-2 ${compact ? 'scale-90 origin-left' : ''}`}>
                <div className="flex items-center gap-1">
                    {coins2 > 0 && <div className="flex items-center -space-x-1"><CoinIcon value={2} className="w-4 h-4 text-[10px]" /><span className="text-yellow-400 font-bold text-xs ml-1">x{coins2}</span></div>}
                    {coins1 > 0 && <div className="flex items-center -space-x-1 ml-1"><CoinIcon value={1} className="w-4 h-4 text-[10px]" /><span className="text-slate-300 font-bold text-xs ml-1">x{coins1}</span></div>}
                </div>
                {curseCount > 0 && (
                    <div className="flex items-center gap-0.5 ml-1 bg-red-900/40 px-1 rounded border border-red-500/30" title={`è©›å’’æ•¸: ${curseCount}`}>
                        <Icons.Skull className="w-3 h-3 text-red-400" />
                        <span className="text-red-300 font-bold text-xs">x{curseCount}</span>
                    </div>
                )}
            </div>
        );

        const HandTracker = ({ hand, usedCards }) => {
            const allCards = Array.from({length: MAX_CARDS}, (_, i) => i + 1);
            return (
                <div className="flex justify-between w-full max-w-[140px]">
                    {allCards.map(num => {
                        const isAvailable = !usedCards.includes(num);
                        return <span key={num} className={`text-[9px] w-3 h-3 flex items-center justify-center rounded-sm leading-none transition-all duration-300 ${isAvailable ? 'text-white font-bold bg-slate-600 border border-slate-500' : 'text-slate-700 bg-slate-900/30 border border-slate-800'}`}>{num}</span>
                    })}
                </div>
            )
        };

        const PlayerStatusBoard = ({ players }) => (
            <div className="grid grid-cols-2 gap-2 bg-slate-800 p-2 shadow-md z-20 border-b border-slate-700">
                {players.map(p => {
                    const currentScore = p.coins1 * 1 + p.coins2 * 2;
                    return (
                        <div key={p.id} className={`flex flex-col p-1.5 rounded border transition-colors duration-300 ${p.id === 0 ? 'bg-blue-900/20 border-blue-500/40' : 'bg-slate-700/20 border-slate-600/40'}`}>
                            <div className="flex justify-between items-center mb-1">
                                <span className={`text-[11px] font-bold ${p.id === 0 ? 'text-blue-300' : 'text-slate-400'}`}>{p.name}</span>
                                <div className="flex items-center gap-2">
                                    <span className="font-bold text-xs px-1.5 rounded shadow-sm text-white bg-black/30">${currentScore}</span>
                                </div>
                            </div>
                            <div className="flex justify-between items-center mb-1">
                                <CoinDisplay coins2={p.coins2} coins1={p.coins1} curseCount={p.curseCount} compact={true} />
                            </div>
                            <HandTracker hand={p.hand} usedCards={p.usedCards} />
                        </div>
                    );
                })}
            </div>
        );

        const MonsterCard = ({ monster, isTarget }) => {
            if (!monster) return <div className="w-24 h-40 border-2 border-dashed border-slate-700 rounded-lg flex items-center justify-center text-slate-600 text-[10px]">è¨ä¼æˆåŠŸ</div>;
            
            // ç§»é™¤èˆŠç‰ˆ HP é–€æª»çš„å±éšªç‹€æ…‹åˆ¤å®š
            // isTarget æ™‚ä»é¡¯ç¤ºå…‰åœˆ
            return (
                <div className={`
                    w-24 h-40 flex-shrink-0 flex flex-col rounded-lg border-2 relative transition-all duration-300 overflow-hidden shadow-lg
                    ${monster.bg}
                    ${isTarget ? 'border-yellow-500 scale-100 z-10 target-glow' : 'border-slate-600 opacity-80 scale-95'}
                `}>
                    <div className="px-2 pt-1 flex justify-between items-center z-10">
                        <span className={`text-[10px] font-black tracking-widest text-white/90`}>{monster.name}</span>
                        {isTarget && <span className={`text-[8px] px-1 rounded font-bold shadow-sm bg-yellow-600 text-white`}>ç‹©çµ</span>}
                        {!isTarget && <span className="text-[9px] text-slate-400/80">#{monster.id}</span>}
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center relative z-10 pb-2">
                        <div className={`text-5xl drop-shadow-xl transition-transform ${isTarget ? 'scale-110' : 'grayscale-[0.3]'}`}>
                            ğŸ§¿
                        </div>
                        <div className={`absolute -bottom-1 -right-1 rounded-tl-lg px-1.5 py-0.5 border-t border-l border-white/20 flex items-center gap-0.5 shadow-md bg-slate-900/90`}>
                            <Icons.Heart className={`w-3 h-3 text-red-500`} />
                            <span className={`text-xs font-black leading-none text-white`}>{monster.hp}/{monster.maxHp}</span>
                        </div>
                    </div>
                    <div className="border-t border-white/20 bg-slate-900/95 flex h-[36px] backdrop-blur-sm">
                        <div className="w-1/3 bg-black/40 border-r border-white/10 flex items-center justify-center">
                            <span className="text-[10px] font-black text-yellow-400 leading-none drop-shadow-sm">
                                ${monster.coins2 * 2 + monster.coins1}
                            </span>
                        </div>
                        <div className="w-2/3 flex flex-col justify-center p-0.5 gap-0.5">
                            <div className="flex flex-wrap justify-start gap-[-2px] min-h-[12px]">
                                {monster.coins2 > 0 && Array.from({length: monster.coins2}).map((_, i) => (
                                    <CoinIcon key={`2-${i}`} value={2} className="w-3 h-3 text-[7px] -ml-1 first:ml-0 shadow-sm border-white/20" />
                                ))}
                            </div>
                            <div className="flex flex-wrap justify-start gap-[-2px] min-h-[12px]">
                                {monster.coins1 > 0 && Array.from({length: monster.coins1}).map((_, i) => (
                                    <CoinIcon key={`1-${i}`} value={1} className="w-3 h-3 text-[7px] -ml-1 first:ml-0 shadow-sm border-white/20" />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PlayerCard = ({ speed, onClick, disabled, selected }) => {
            const config = getCardConfig(speed);
            return (
                <button onClick={onClick} disabled={disabled} className={`w-16 h-24 flex-shrink-0 rounded-lg border-2 relative transition-all duration-150 card-active overflow-hidden shadow-lg ${config.color} ${config.border} ${config.text} ${selected ? 'ring-2 ring-yellow-400 -translate-y-3 shadow-yellow-900/50' : ''} ${disabled ? 'opacity-40 grayscale cursor-not-allowed' : 'hover:-translate-y-1'}`}>
                    <div className="absolute top-1 left-1 flex flex-col items-center leading-none z-10"><span className="text-[8px] opacity-80">SPD</span><span className="text-sm font-black">{speed}</span></div>
                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><div className="text-4xl mb-1 drop-shadow-md opacity-90 filter grayscale-[0.1] contrast-125 transform hover:scale-110 transition-transform">{config.emoji}</div></div>
                    <div className="absolute bottom-0 inset-x-0 bg-black/40 py-0.5 flex justify-center items-center gap-1 border-t border-white/10 z-10"><span className="text-[9px]">ğŸ—¡ï¸</span><span className="text-sm font-bold">{config.power}</span></div>
                    <div className="absolute top-1 right-1 text-[8px] font-bold opacity-70 tracking-tighter writing-vertical-rl">{config.name}</div>
                </button>
            );
        };

        const EnhancementControls = ({ player, bet, setBet }) => {
            if (!player) return null;
            const handleBetChange = (type, delta) => {
                const currentBetVal = type === 1 ? bet.coins1 : bet.coins2;
                const playerMax = type === 1 ? player.coins1 : player.coins2;
                const newVal = currentBetVal + delta;
                if (newVal >= 0 && newVal <= playerMax) setBet(prev => ({ ...prev, [type === 1 ? 'coins1' : 'coins2']: newVal }));
            };
            const bonusPower = bet.coins1 * 1 + bet.coins2 * 2; 
            return (
                <div className="bg-slate-800/90 p-2 rounded-t-lg border-t border-x border-slate-600 flex items-center justify-between w-full max-w-sm mx-auto mb-2 shadow-lg">
                    <div className="text-[10px] font-bold text-slate-400 mr-2 flex flex-col items-center leading-tight"><span>å¼·åŒ–</span><span>è§’è‰²</span></div>
                    <div className="flex gap-4">
                        <div className="flex items-center gap-1 bg-slate-900/50 rounded px-1 py-0.5 border border-slate-700">
                            <button onClick={() => handleBetChange(2, -1)} className="w-5 h-5 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600 disabled:opacity-30" disabled={bet.coins2 <= 0}><Icons.Minus /></button>
                            <div className="flex flex-col items-center w-6"><CoinIcon value={2} className="w-4 h-4 text-[9px] scale-90" /><span className="text-[10px] text-yellow-400 font-bold">{bet.coins2}</span></div>
                            <button onClick={() => handleBetChange(2, 1)} className="w-5 h-5 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600 disabled:opacity-30" disabled={bet.coins2 >= player.coins2}><Icons.Plus /></button>
                        </div>
                        <div className="flex items-center gap-1 bg-slate-900/50 rounded px-1 py-0.5 border border-slate-700">
                            <button onClick={() => handleBetChange(1, -1)} className="w-5 h-5 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600 disabled:opacity-30" disabled={bet.coins1 <= 0}><Icons.Minus /></button>
                            <div className="flex flex-col items-center w-6"><CoinIcon value={1} className="w-4 h-4 text-[9px] scale-90" /><span className="text-[10px] text-slate-300 font-bold">{bet.coins1}</span></div>
                            <button onClick={() => handleBetChange(1, 1)} className="w-5 h-5 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600 disabled:opacity-30" disabled={bet.coins1 >= player.coins1}><Icons.Plus /></button>
                        </div>
                    </div>
                    <div className="ml-3 flex items-center text-orange-400 font-black text-sm bg-orange-900/20 px-2 py-1 rounded border border-orange-500/30">
                        <Icons.Fire /> 
                        <span className="ml-1">+{bonusPower}</span>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [players, setPlayers] = useState([]);
            const [monsters, setMonsters] = useState([]);
            const [round, setRound] = useState(1);
            const [logs, setLogs] = useState([]);
            const [gameState, setGameState] = useState('init'); 
            const [showLogs, setShowLogs] = useState(true);
            const [showRules, setShowRules] = useState(false);
            const [showEndModal, setShowEndModal] = useState(false); 
            const [currentBet, setCurrentBet] = useState({ coins1: 0, coins2: 0 }); 
            const logsEndRef = useRef(null);

            useEffect(() => { initGame(); }, []);
            useEffect(() => { 
                if(showLogs) {
                    requestAnimationFrame(() => {
                        logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
                    });
                }
            }, [logs, showLogs]);

            const initGame = () => {
                setShowEndModal(false);
                const newPlayers = Array.from({ length: PLAYER_COUNT }).map((_, i) => {
                    const names = ["ä½ ", "æ¸¬è©¦è€…A", "æ¸¬è©¦è€…B", "æ¸¬è©¦è€…C"];
                    return {
                        id: i, 
                        name: names[i], 
                        isAI: i !== 0,
                        hand: Array.from({ length: MAX_CARDS }, (_, k) => k + 1),
                        usedCards: [],
                        coins1: INITIAL_COINS1, 
                        coins2: INITIAL_COINS2,
                        curseCount: 0, 
                        lastPlayed: null, 
                        lastBetPower: 0
                    };
                });
                
                let newMonsters = Array.from({ length: MONSTER_COUNT }).map((_, i) => {
                    const hp = Math.floor(Math.random() * 10) + 10; 
                    let coins2, coins1, totalValue;
                    do {
                        coins2 = Math.floor(Math.random() * 5) + 1;
                        coins1 = Math.floor(Math.random() * 5) + 2; 
                        totalValue = (coins2 * 2) + coins1;
                    } while (totalValue < 7 || totalValue > 13);
                    
                    return { id: i + 1, hp: hp, maxHp: hp, coins2: coins2, coins1: coins1, name: generateMonsterName(), bg: getRandomBg() };
                });
                
                setPlayers(newPlayers); 
                setMonsters(newMonsters); 
                setRound(1);
                setLogs([{text: "è¨ä¼æˆ°é–‹å§‹ï¼è«‹é¸æ“‡ä½ è¦æ´¾é£çš„è§’è‰²ã€‚", type: 'title', id: Date.now()}]);
                setGameState('selection'); 
                setCurrentBet({ coins1: 0, coins2: 0 });
            };

            const handleCardSelect = (speed) => {
                if (gameState !== 'selection') return;
                const nextPlayers = [...players];
                const p0 = nextPlayers[0];
                
                if (p0.usedCards.includes(speed)) return;

                p0.lastPlayed = speed;
                p0.usedCards.push(speed); 
                p0.coins1 -= currentBet.coins1; p0.coins2 -= currentBet.coins2;
                p0.lastBetPower = currentBet.coins1 * 1 + currentBet.coins2 * 2;
                setCurrentBet({ coins1: 0, coins2: 0 });

                for(let i=1; i<PLAYER_COUNT; i++){
                    const ai = nextPlayers[i];
                    const availableCards = ai.hand.filter(c => !ai.usedCards.includes(c));

                    if (availableCards.length === 0) {
                        ai.lastPlayed = null;
                        ai.lastBetPower = 0;
                        continue; 
                    }

                    const rIdx = Math.floor(Math.random() * availableCards.length);
                    ai.lastPlayed = availableCards[rIdx]; 
                    ai.usedCards.push(ai.lastPlayed); 
                    
                    let bet1 = 0; 
                    let bet2 = 0;
                    if (Math.random() < 0.3) {
                        if (ai.coins2 > 0 && Math.random() < 0.5) bet2 = 1;
                        else if (ai.coins1 > 0) bet1 = 1;
                    }
                    ai.coins1 -= bet1; ai.coins2 -= bet2;
                    ai.lastBetPower = bet1 * 1 + bet2 * 2; 
                }

                setPlayers(nextPlayers); 
                setGameState('resolving'); 
                setTimeout(() => resolveRound(nextPlayers), 1500); 
            };

            const resolveRound = (currentPlayers) => {
                let moves = currentPlayers.filter(p => p.lastPlayed !== null).map(p => {
                    const config = getCardConfig(p.lastPlayed);
                    return { ...p, speed: p.lastPlayed, power: config.power + p.lastBetPower, basePower: config.power, emoji: config.emoji };
                }).sort((a,b) => a.speed - b.speed);
                
                let groups = {}; 
                moves.forEach(m => { 
                    if(!groups[m.speed]) groups[m.speed] = []; 
                    groups[m.speed].push(m); 
                });
                
                let currentMonsters = [...monsters];
                let tempPlayers = JSON.parse(JSON.stringify(currentPlayers)); 
                let roundLog = [];
                let logIdCounter = Date.now();
                
                // è¨˜éŒ„å‚·å®³ä¾†æº (ç”¨æ–¼è©›å’’åˆ¤å®š)
                let monsterHitHistory = {};

                roundLog.push({text: `--- ç¬¬ ${round} å›åˆ ---`, type: 'title', id: logIdCounter++});

                Object.keys(groups).sort((a,b)=>a-b).forEach(speed => {
                    if(currentMonsters.length === 0) return; 

                    const attackers = groups[speed];
                    const totalDmg = attackers.reduce((sum, a) => sum + a.power, 0);
                    const emoji = attackers[0].emoji;
                    const attackersNames = attackers.map(a => a.lastBetPower > 0 ? `${a.name}(ğŸ”¥+${a.lastBetPower})` : a.name).join(', ');
                    
                    roundLog.push({ text: `âš¡ï¸${speed} ${emoji} [${attackersNames}] â¡ï¸ ğŸ—¡ï¸ç¸½å‚· ${totalDmg}`, type: 'highlight', id: logIdCounter++ });

                    let dmgRemaining = totalDmg;
                    while(dmgRemaining > 0 && currentMonsters.length > 0) {
                        let target = currentMonsters[0];
                        
                        if (!monsterHitHistory[target.id]) monsterHitHistory[target.id] = [];
                        attackers.forEach(atk => {
                             monsterHitHistory[target.id].push({ playerId: atk.id, speed: parseInt(speed) });
                        });

                        if(dmgRemaining >= target.hp) {
                            let overkill = dmgRemaining - target.hp;
                            roundLog.push({text: `ğŸ’¥ æ“Šæ®º ${target.name}ï¼`, type: 'kill', id: logIdCounter++});
                            
                            const coins2Share = Math.floor(target.coins2 / attackers.length);
                            const coins2Rem = target.coins2 % attackers.length;
                            const coins1Share = Math.floor(target.coins1 / attackers.length);
                            const coins1Rem = target.coins1 % attackers.length;
                            
                            attackers.forEach(atk => {
                                let p = tempPlayers.find(tp => tp.id === atk.id);
                                p.coins2 += coins2Share; 
                                p.coins1 += coins1Share;
                            });
                            
                            if(coins2Share || coins1Share) {
                                roundLog.push({text: `ğŸ’° å‰å–: $2x${coins2Share}, $1x${coins1Share} (æ¯äºº)`, type: 'normal', id: logIdCounter++});
                            }

                            currentMonsters.shift(); 
                            
                            if(currentMonsters.length > 0) {
                                currentMonsters[0].coins2 += coins2Rem; 
                                currentMonsters[0].coins1 += coins1Rem;
                                if(coins2Rem || coins1Rem) {
                                    roundLog.push({text: `â¡ï¸ é¤˜æ•¸çå‹µè½‰ç§»åˆ° ${currentMonsters[0].name}`, type: 'transfer', id: logIdCounter++});
                                }
                                dmgRemaining = overkill; 
                            } else {
                                dmgRemaining = 0; 
                            }
                        } else {
                            target.hp -= dmgRemaining;
                            roundLog.push({text: `ğŸ—¡ï¸ é€ æˆ ${dmgRemaining} å‚·å®³ (å‰© HP ${target.hp})`, type: 'normal', id: logIdCounter++});
                            dmgRemaining = 0; 
                        }
                    }
                });

                // --- è©›å’’åˆ¤å®š (æ›´æ–°ï¼šåªè¦è¢«æ”»æ“Šä¸”å­˜æ´»å°±è©›å’’) ---
                // æª¢æŸ¥ç›®å‰å­˜æ´»çš„é­”ç‰©æ˜¯å¦åœ¨æœ¬å›åˆè¢«æ”»æ“Šé
                currentMonsters.forEach(activeMonster => {
                    const hits = monsterHitHistory[activeMonster.id];
                    if (hits && hits.length > 0) {
                        roundLog.push({text: `â˜ ï¸ ${activeMonster.name} å­˜æ´»åå™¬ï¼(HP ${activeMonster.hp})`, type: 'curse-title', id: logIdCounter++});
                        
                        // æ‰¾å‡ºæœ€å¾Œæ”»æ“Šè©²é­”ç‰©çš„ç©å®¶ (é€Ÿåº¦å€¼æœ€å¤§è€…)
                        const maxSpeed = Math.max(...hits.map(h => h.speed));
                        const lastHitters = hits.filter(h => h.speed === maxSpeed);
                        const uniqueVictims = [...new Set(lastHitters.map(h => h.playerId))];

                        uniqueVictims.forEach(pid => {
                            let p = tempPlayers.find(tp => tp.id === pid);
                            p.curseCount += 1;
                            roundLog.push({text: `ğŸ˜± ${p.name} è¢«è©›å’’äº†ï¼ (è©›å’’+1)`, type: 'curse', id: logIdCounter++});
                        });
                    }
                });

                setLogs(prev => [...prev, ...roundLog]); 
                setMonsters(currentMonsters); 
                setPlayers(tempPlayers); 

                if(round >= MAX_ROUNDS || currentMonsters.length === 0) { 
                    setGameState('gameover'); 
                    setShowLogs(true);
                    setShowEndModal(true);
                } else { 
                    setRound(prev => prev + 1); 
                    setGameState('selection'); 
                }
            };

            if (gameState === 'init') {
                return (
                    <div className="flex items-center justify-center h-screen text-slate-500 animate-pulse">
                        æ­£åœ¨è¼‰å…¥å…¬æœƒè³‡æ–™...
                    </div>
                );
            }

            return (
                <div className="flex-1 flex flex-col h-full bg-slate-900 overflow-hidden relative">
                    {showRules && <RulesModal onClose={() => setShowRules(false)} />}
                    {showEndModal && <GameEndModal players={players} onRestart={initGame} onClose={() => setShowEndModal(false)} />}
                    
                    <PlayerStatusBoard players={players} />
                    <div className="bg-slate-900/50 px-3 py-2 border-b border-slate-700 flex justify-between items-center shadow-sm relative z-30">
                        <div className="flex items-center gap-3">
                            <h1 className="text-sm sm:text-base font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 tracking-wide shadow-black drop-shadow-sm">é­”ç‰©è¨ä¼æˆ°ï¼šè©›å’’ä¹‹é‹’</h1>
                            <button onClick={() => setShowRules(true)} className="bg-red-800 hover:bg-red-700 text-white px-3 py-1.5 rounded-md shadow flex items-center gap-1.5 transition-transform active:scale-95 text-xs font-bold border border-red-500/50" title="éŠæˆ²è¦å‰‡"><Icons.Book /> <span>è¦å‰‡èªªæ˜</span></button>
                        </div>
                        <div className="flex items-center gap-2 text-xs font-bold text-slate-400">
                            <span className="bg-black/30 px-2 py-1 rounded border border-white/5 text-yellow-500">Round {round} / {MAX_ROUNDS}</span>
                             {gameState === 'gameover' && <button onClick={initGame} className="bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded shadow flex items-center gap-1 animate-pulse"><Icons.Refresh /> <span className="hidden sm:inline">é‡ç©</span></button>}
                        </div>
                    </div>
                    <div className="bg-gradient-to-b from-slate-900 to-slate-800 py-2 flex-shrink-0 relative border-b border-slate-700">
                        <div className="text-[10px] text-slate-500 mb-1 px-3 flex justify-between">
                            <span>ç‹©çµ<strong className="text-red-400">é­”ç‰©</strong> (å‰© {monsters.length} éš»)</span>
                            <span className="text-red-400 font-bold animate-pulse">âš  æ”»æ“Šæœªæ“Šæ®º = è©›å’’</span>
                        </div>
                        <div className="flex gap-2 overflow-x-auto hide-scrollbar px-3 items-center min-h-[170px]">{monsters.length === 0 ? <div className="w-full text-center text-slate-500 italic text-xs py-8">æ‰€æœ‰å¤§å‹é­”ç‰©è¨ä¼å®Œæˆï¼</div> : monsters.map((m, i) => <MonsterCard key={m.id} monster={m} isTarget={i===0} />)}</div>
                    </div>
                    <div className="flex-1 min-h-0 bg-slate-950/30 flex flex-col relative">
                        <div className="bg-slate-800/80 backdrop-blur px-3 py-1 text-[10px] text-slate-400 flex justify-between items-center cursor-pointer border-b border-slate-700" onClick={() => setShowLogs(!showLogs)}><span>ç‹©çµç´€éŒ„</span>{showLogs ? <Icons.ChevronDown /> : <Icons.ChevronUp />}</div>
                        {showLogs && 
                            <div className="flex-1 overflow-y-auto p-3 text-[11px] font-mono space-y-1 custom-scrollbar">
                                {logs.map((log, index) => 
                                    <div 
                                        key={log.id || index} 
                                        className={`
                                            ${log.type === 'title' ? 'text-yellow-400 font-bold mt-2 border-b border-slate-800 pb-0.5' : ''} 
                                            ${log.type === 'highlight' ? 'text-cyan-300 mt-0.5' : ''} 
                                            ${log.type === 'kill' ? 'text-green-400 font-bold bg-green-900/10 px-1 rounded inline-block' : ''} 
                                            ${log.type === 'transfer' ? 'text-purple-300 italic' : ''} 
                                            ${log.type === 'curse-title' ? 'text-red-500 font-black text-xs mt-1 animate-pulse' : ''} 
                                            ${log.type === 'curse' ? 'text-red-300 font-bold bg-red-950/30 px-1 border border-red-900/50 rounded' : ''} 
                                            ${log.type === 'normal' ? 'text-slate-400' : ''}
                                        `}>
                                            {log.text}
                                    </div>
                                )}
                                <div ref={logsEndRef} />
                            </div>
                        }
                    </div>
                    <div className="bg-slate-900 pt-2 pb-safe border-t border-slate-700 z-30 flex flex-col">
                        {gameState === 'selection' && players[0] && <EnhancementControls player={players[0]} bet={currentBet} setBet={setCurrentBet} />}
                        <div className="px-2 pb-2">
                            <div className="text-[10px] text-slate-500 mb-1 flex justify-between px-1"><span>é¸æ“‡æ´¾é£è§’è‰²</span>{gameState === 'resolving' && <span className="text-yellow-500 animate-pulse">æˆ°é¬¥çµç®—ä¸­...</span>}</div>
                            <div className="flex gap-1.5 overflow-x-auto hide-scrollbar pb-1 px-1">
                                {gameState === 'gameover' ? (
                                    <div className="w-full text-center py-4">
                                        <div className="text-sm font-bold text-white mb-1">æœ€çµ‚æ’å</div>
                                        {/* åº•éƒ¨æ’åé¡¯ç¤º */}
                                        {(() => {
                                            const maxCurses = Math.max(...players.map(p => p.curseCount));
                                            const computed = players.map(p => {
                                                const rawScore = p.coins1 + p.coins2 * 2;
                                                const isPenalized = maxCurses > 0 && p.curseCount === maxCurses;
                                                // é‡‘å¹£æ¸›åŠï¼Œä¸æ¨å»å°æ•¸é»
                                                const finalScore = isPenalized ? rawScore / 2 : rawScore;
                                                return { ...p, finalScore, isPenalized };
                                            }).sort((a,b) => b.finalScore - a.finalScore);
                                            
                                            return computed.map((p,i) => 
                                                <div key={p.id} className={`text-xs ${p.isPenalized ? 'text-red-400' : (i===0 ? 'text-yellow-400 font-bold' : 'text-slate-400')}`}>
                                                    #{i+1} {p.name}: ${p.finalScore} {p.isPenalized ? '(é‡‘å¹£æ¸›åŠ)' : ''}
                                                </div>
                                            );
                                        })()}
                                    </div>
                                ) : (
                                    players[0]?.hand.length === 0 ? (
                                        <div className="text-slate-500 w-full text-center py-4 text-xs">ç‰Œå·²å‡ºå®Œ</div>
                                    ) : (
                                        players[0]?.hand.map(speed => 
                                            <PlayerCard 
                                                key={speed} 
                                                speed={speed} 
                                                disabled={gameState !== 'selection' || players[0].usedCards.includes(speed)} 
                                                onClick={() => handleCardSelect(speed)} 
                                            />
                                        )
                                    )
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>